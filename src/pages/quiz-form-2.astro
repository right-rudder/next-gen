---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import { MdOutlineQuiz } from "react-icons/md";
import quizForm from "../data/quiz-form";

const { data } = quizForm;
const QUIZ_FORM_WEBHOOK_URL = import.meta.env.QUIZ_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;

// Define the quiz questions as an array of objects
const quizQuestions = [
  {
    section: "Personal Information",
    fields: [
      {
        type: "text",
        id: "first-name",
        name: "first-name",
        label: "First name",
        autocomplete: "given-name",
        required: true,
        colSpan: "sm:col-span-3",
      },
      {
        type: "text",
        id: "last-name",
        name: "last-name",
        label: "Last name",
        autocomplete: "family-name",
        required: true,
        colSpan: "sm:col-span-3",
      },
      {
        type: "email",
        id: "email",
        name: "email",
        label: "Email address",
        autocomplete: "email",
        required: true,
        colSpan: "sm:col-span-3",
      },
      {
        type: "tel",
        id: "phone",
        name: "phone",
        label: "Phone",
        autocomplete: "phone",
        required: true,
        colSpan: "sm:col-span-3",
      },
    ],
  },
  {
    section: "Preferred Method of Contact",
    type: "radio",
    name: "method-contact",
    legend: "Preferred method of contact",
    options: [
      { id: "method-contact-email", value: "Email", label: "Email" },
      { id: "method-contact-phone", value: "Phone call", label: "Phone Call" },
      {
        id: "method-contact-text",
        value: "Text message",
        label: "Text message",
      },
    ],
  },
  {
    section: "Flight Experience",
    type: "radio",
    name: "flight-experience",
    legend: "Do you have any prior flight experience or training?",
    hasOther: true,
    otherId: "experience-other",
    otherTextId: "experience-other-text",
    otherErrorId: "experience-other-error",
    options: [
      {
        id: "experience-no",
        value: "No prior experience",
        label: "No prior experience",
      },
      {
        id: "experience-sim",
        value: "Flight simulator experience",
        label: "Flight simulator experience",
      },
      {
        id: "experience-drones",
        value: "Drone piloting experience",
        label: "Drone piloting experience",
      },
      {
        id: "experience-lessons",
        value: "Some flight lessons",
        label: "Some flight lessons",
      },
      {
        id: "experience-other",
        value: "Other:",
        label: "Other (please specify)",
        isOther: true,
      },
    ],
  },
  {
    section: "Aspirations and Mindset",
    type: "checkbox",
    name: "inspirations",
    legend: "What inspires you to pursue a career as a pilot?",
    note: "You can select multiple options",
    hasOther: true,
    otherId: "other",
    otherTextId: "other-text",
    otherErrorId: "other-error-msg",
    options: [
      {
        id: "adventure",
        value: "A passion for adventure",
        label: "A passion for adventure",
      },
      {
        id: "opportunities",
        value: "Professional growth and opportunities",
        label: "Professional growth and opportunities",
      },
      {
        id: "hobby",
        value: "Personal hobby",
        label: "Personal hobby",
      },
      {
        id: "other",
        value: "Other:",
        label: "Other (please specify)",
        isOther: true,
      },
    ],
  },
  {
    type: "radio",
    name: "plane-reaction",
    legend:
      "When a plane flies overhead during a conversation, how do you react?",
    options: [
      {
        id: "plane-identify",
        value: "I immediately try to identify it",
        label: "I immediately try to identify it",
      },
      {
        id: "plane-wish",
        value: "I wish I were up there",
        label: "I wish I were up there",
      },
      {
        id: "plane-glance",
        value: "I glance at it and continue",
        label: "I glance at it and continue",
      },
      {
        id: "plane-focused",
        value: "I acknowledge it but stay focused",
        label: "I acknowledge it but stay focused",
      },
      {
        id: "plane-not-notice",
        value: "I don't notice it",
        label: "I don't notice it",
      },
    ],
  },
  {
    type: "radio",
    name: "pilot-type",
    legend: "What kind of pilot do you aspire to be?",
    options: [
      {
        id: "type-recreational",
        value: "Recreational/Hobby Pilot",
        label: "Recreational/Hobby Pilot",
      },
      {
        id: "type-cfi",
        value: "Flight Instructor (CFI)",
        label: "Flight Instructor (CFI)",
      },
      { id: "type-airline", value: "Airline Pilot", label: "Airline Pilot" },
      {
        id: "type-corporate",
        value: "Corporate/Business Pilot",
        label: "Corporate/Business Pilot",
      },
      { id: "type-military", value: "Military Pilot", label: "Military Pilot" },
      {
        id: "type-helicopter",
        value: "Helicopter Pilot",
        label: "Helicopter Pilot",
      },
      {
        id: "type-unsure",
        value: "Still exploring options",
        label: "Still exploring options",
      },
    ],
  },
  {
    type: "checkbox",
    name: "learning-methods",
    legend: "Which learning methods do you prefer?",
    note: "Select all that apply",
    options: [
      {
        id: "learn-visual",
        value: "Visual (e.g., diagrams, videos)",
        label: "Visual (e.g., diagrams, videos)",
      },
      {
        id: "learn-auditory",
        value: "Auditory (e.g., lectures, discussions)",
        label: "Auditory (e.g., lectures, discussions)",
      },
      {
        id: "learn-reading",
        value: "Reading/Writing (e.g., manuals, note-taking)",
        label: "Reading/Writing (e.g., manuals, note-taking)",
      },
      {
        id: "learn-kinesthetic",
        value: "Kinesthetic (e.g., hands-on practice, simulations)",
        label: "Kinesthetic (e.g., hands-on practice, simulations)",
      },
    ],
  },
  {
    type: "checkbox",
    name: "training-formats",
    legend: "Which of the following training formats are you interested in?",
    note: "Select all that apply",
    options: [
      {
        id: "format-one-on-one",
        value: "One-on-one instruction (most personalized)",
        label: "One-on-one instruction (most personalized)",
      },
      {
        id: "format-small-group",
        value: "Small group classes",
        label: "Small group classes",
      },
      {
        id: "format-online",
        value: "Online/self-paced ground school",
        label: "Online/self-paced ground school",
      },
      {
        id: "format-hybrid",
        value: "Hybrid (in-person + online)",
        label: "Hybrid (in-person + online)",
      },
      {
        id: "format-accelerated",
        value: "Accelerated/immersion program",
        label: "Accelerated/immersion program",
      },
    ],
  },
  {
    type: "radio",
    name: "pilot-certainty",
    legend: "How certain are you about becoming a pilot?",
    options: [
      { id: "pilot-certainty-100", value: "100%", label: "100%" },
      { id: "pilot-certainty-90", value: "90%", label: "90%" },
      { id: "pilot-certainty-75", value: "75%", label: "75%" },
      {
        id: "pilot-certainty-less-75",
        value: "Less than 75%",
        label: "Less than 75%",
      },
      {
        id: "pilot-certainty-still-considering",
        value: "Still considering",
        label: "Still considering",
      },
    ],
  },
  {
    type: "radio",
    name: "preferred-approach",
    legend:
      "Do you prefer a structured learning environment with clearly defined expectations, or a more flexible, adaptable approach?",
    options: [
      {
        id: "structured",
        value: "I prefer a structured approach",
        label: "I prefer a structured approach",
      },
      {
        id: "flexible",
        value: "I prefer a flexible approach",
        label: "I prefer a flexible approach",
        required: true,
      },
    ],
  },
  {
    type: "checkbox",
    name: "kind-of-guidance",
    legend:
      "What kind of guidance and support would you prefer from your flight instructor?",
    note: "You can select multiple options",
    hasOther: true,
    otherId: "other2",
    otherTextId: "other2-text",
    otherErrorId: "other2-error-msg",
    options: [
      {
        id: "personalized-approach",
        value:
          "A personalized approach tailored to my individual learning needs and preferences",
        label:
          "A personalized approach tailored to my individual learning needs and preferences",
      },
      {
        id: "hands-on-involvement",
        value:
          "Hands-on involvement from the instructor, with constant feedback and guidance",
        label:
          "Hands-on involvement from the instructor, with constant feedback and guidance",
      },
      {
        id: "structured-approach",
        value: "A structured approach with clear goals and objectives",
        label: "A structured approach with clear goals and objectives",
      },
      {
        id: "guidance",
        value:
          "Supportive and encouraging guidance, with a focus on building confidence",
        label:
          "Supportive and encouraging guidance, with a focus on building confidence",
      },
      {
        id: "other2",
        value: "Other:",
        label: "Other (please specify)",
        isOther: true,
      },
    ],
  },
  {
    type: "radio",
    name: "problem-solving",
    legend:
      "You have a major project due tomorrow and are only partially through. What do you do?",
    options: [
      {
        id: "solve-ahead",
        value: "Complete it ahead of schedule",
        label: "Complete it ahead of schedule",
      },
      {
        id: "solve-work",
        value: "Work through the night if needed",
        label: "Work through the night if needed",
      },
      {
        id: "solve-extension",
        value: "Request an extension",
        label: "Request an extension",
      },
      {
        id: "solve-break",
        value: "Take a short break and continue",
        label: "Take a short break and continue",
      },
      {
        id: "solve-overwhelmed",
        value: "Feel overwhelmed and freeze up",
        label: "Feel overwhelmed and freeze up",
      },
    ],
  },
  {
    type: "radio",
    name: "education-degree",
    legend: "Do you currently hold a college degree?",
    options: [
      { id: "degree-yes", value: "Yes", label: "Yes" },
      { id: "degree-no", value: "No", label: "No" },
      {
        id: "degree-current",
        value: "Currently pursuing",
        label: "Currently pursuing",
      },
    ],
  },
  {
    type: "radio",
    name: "education-interest",
    legend:
      "Are you interested in pursuing a degree in conjunction with your flight training?",
    note: "NextGen has partnerships with aviation degree programs",
    options: [
      {
        id: "edu-before",
        value: "Yes, before flight training",
        label: "Yes, before flight training",
      },
      {
        id: "edu-during",
        value: "Yes, during flight training",
        label: "Yes, during flight training",
      },
      {
        id: "edu-after",
        value: "Yes, after flight training",
        label: "Yes, after flight training",
      },
      {
        id: "edu-no",
        value: "No, flight training only",
        label: "No, flight training only",
      },
    ],
  },
  {
    section: "Medical Fitness",
    note: "All pilots must obtain an FAA Medical Certificate. It's essential to assess your medical fitness early in your training journey.",
    fields: [],
  },
  {
    type: "radio",
    name: "medical-age-range",
    legend: "Age range",
    required: true,
    options: [
      { id: "medical-age-under-25", value: "Under 25", label: "Under 25" },
      { id: "medical-age-26-55", value: "26-55", label: "26-55" },
      { id: "medical-age-over-55", value: "Over 55", label: "Over 55" },
    ],
  },
  {
    type: "radio",
    name: "medical-weight-range",
    legend: "Weight range",
    required: true,
    options: [
      {
        id: "medical-weight-under-200-lbs",
        value: "Under 200 lbs",
        label: "Under 200 lbs",
      },
      {
        id: "medical-weight-200-250-lbs",
        value: "200-250 lbs",
        label: "200-250 lbs",
      },
      {
        id: "medical-weight-over-250-lbs",
        value: "Over 250 lbs",
        label: "Over 250 lbs",
      },
    ],
  },
  {
    type: "radio",
    name: "medical-conditions",
    legend:
      "Do you currently have any known medical conditions that might affect your ability to obtain an FAA Medical Certificate?",
    required: true,
    options: [
      { id: "medical-conditions-yes", value: "Yes", label: "Yes" },
      { id: "medical-conditions-no", value: "No", label: "No" },
      { id: "medical-conditions-unsure", value: "Unsure", label: "Unsure" },
    ],
  },
  {
    type: "radio",
    name: "medical-medication",
    legend: "Are you currently taking any medications?",
    required: true,
    note: "If you are taking medications or have medical conditions, we recommend consulting with an FAA-certified Aviation Medical Examiner (AME) to determine your eligibility for a medical certificate.",
    options: [
      { id: "medical-medication-yes", value: "Yes", label: "Yes" },
      { id: "medical-medication-no", value: "No", label: "No" },
      {
        id: "medical-medication-not-saying",
        value: "Prefer not to say",
        label: "Prefer not to say",
      },
    ],
  },
  {
    section: "Time Commitment",
    fields: [],
  },
  {
    type: "radio",
    name: "time-commitment-weekly",
    legend: "How many flying lessons do you plan to schedule per week?",
    required: true,
    options: [
      {
        id: "time-commitment-weekly-1-or-fewer",
        value: "1 or fewer",
        label: "1 or fewer",
      },
      { id: "time-commitment-weekly-2-3", value: "2-3", label: "2-3" },
      {
        id: "time-commitment-weekly-4-or-more",
        value: "4 or more",
        label: "4 or more",
      },
    ],
  },
  {
    type: "radio",
    name: "time-commitment-flexibility",
    legend:
      "Do you have flexibility in your schedule to accommodate additional study or practice time?",
    required: true,
    note: "Consistent practice and study are crucial for success in flight training. Less frequent flying can lead to longer training durations and increased costs.",
    options: [
      { id: "time-commitment-flexibility-yes", value: "Yes", label: "Yes" },
      { id: "time-commitment-flexibility-no", value: "No", label: "No" },
      {
        id: "time-commitment-flexibility-limited",
        value: "Limited flexibility",
        label: "Limited flexibility",
      },
    ],
  },
  {
    section: "Financial Planning",
    type: "radio",
    name: "financial",
    legend:
      "Have you prepared financially for the costs associated with flight training?",
    required: true,
    options: [
      {
        id: "financial-yes-full-amount",
        value:
          "Yes, I have the full amount saved (~$12,000 for a Private Pilot License)",
        label:
          "Yes, I have the full amount saved (~$12,000 for a Private Pilot License)",
      },
      {
        id: "financial-yes-as-i-go",
        value: "Yes, I plan to pay as I go",
        label: "Yes, I plan to pay as I go",
      },
      {
        id: "financial-yes-assitance",
        value:
          "Yes, I have financial assistance (e.g., Stratus, scholarships, employer reimbursement)",
        label:
          "Yes, I have financial assistance (e.g., Stratus, scholarships, employer reimbursement)",
      },
      {
        id: "financial-no",
        value: "No, I need guidance on financing options",
        label: "No, I need guidance on financing options",
      },
    ],
  },
  {
    section: "Motivation & Drive",
    type: "checkbox",
    name: "motivation-factors",
    legend: "What motivates you to pursue flight training?",
    options: [
      {
        id: "motivate-adventure",
        value: "Sense of adventure and freedom",
        label: "Sense of adventure and freedom",
      },
      {
        id: "motivate-career",
        value: "Career advancement and opportunities",
        label: "Career advancement and opportunities",
      },
      {
        id: "motivate-challenge",
        value: "Personal challenge and achievement",
        label: "Personal challenge and achievement",
      },
      {
        id: "motivate-travel",
        value: "Ability to travel",
        label: "Ability to travel",
      },
      {
        id: "motivate-family",
        value: "Family tradition/influence",
        label: "Family tradition/influence",
      },
      {
        id: "motivate-income",
        value: "High earning potential",
        label: "High earning potential",
      },
      {
        id: "motivate-flexibility",
        value: "Schedule flexibility",
        label: "Schedule flexibility",
      },
    ],
  },
  {
    type: "radio",
    name: "timeline",
    legend: "When do you hope to start flight training?",
    options: [
      {
        id: "timeline-immediate",
        value: "Immediately (within 30 days)",
        label: "Immediately (within 30 days)",
      },
      {
        id: "timeline-3months",
        value: "Within 3 months",
        label: "Within 3 months",
      },
      {
        id: "timeline-6months",
        value: "Within 6 months",
        label: "Within 6 months",
      },
      { id: "timeline-year", value: "Within 1 year", label: "Within 1 year" },
      {
        id: "timeline-exploring",
        value: "Just exploring for now",
        label: "Just exploring for now",
      },
    ],
  },
  {
    type: "radio",
    name: "support-system",
    legend: "Do you have family/friend support for your flight training?",
    options: [
      {
        id: "support-strong",
        value: "Strong support system",
        label: "Strong support system",
      },
      { id: "support-some", value: "Some support", label: "Some support" },
      {
        id: "support-neutral",
        value: "Neutral/indifferent",
        label: "Neutral/indifferent",
      },
      {
        id: "support-little",
        value: "Little to no support",
        label: "Little to no support",
      },
      {
        id: "support-not-sure",
        value: "Prefer not to say",
        label: "Prefer not to say",
      },
    ],
  },
];

const additionalQuestions = [
  {
    type: "checkbox",
    name: "heard-about",
    legend: "How did you hear about NextGen Flight Academy?",
    hasOther: true,
    otherId: "source-other",
    otherTextId: "source-other-text",
    otherErrorId: "source-other-error",
    options: [
      { id: "source-google", value: "Google search", label: "Google search" },
      {
        id: "source-social",
        value: "Social media (Facebook, Instagram, TikTok)",
        label: "Social media (Facebook, Instagram, TikTok)",
      },
      {
        id: "source-friend",
        value: "Referred by a friend or pilot",
        label: "Referred by a friend or pilot",
      },
      {
        id: "source-visit",
        value: "Visited the airport",
        label: "Visited the airport",
      },
      {
        id: "source-event",
        value: "Aviation event or airshow",
        label: "Aviation event or airshow",
      },
      {
        id: "source-school",
        value: "School/college career fair",
        label: "School/college career fair",
      },
      {
        id: "source-other",
        value: "Other:",
        label: "Other (please specify)",
        isOther: true,
      },
    ],
  },
];
// Create array of other fields for JavaScript validation
const otherFields = quizQuestions
  .filter((q) => q.hasOther)
  .map((q) => ({
    id: q.otherId,
    idText: q.otherTextId,
    idErrorMsg: q.otherErrorId,
  }));
---

<BaseLayout
  siteTitle={data.pageTitle}
  siteDescription={data.pageDescription}
  keywords={data.pageKeywords}
>
  <Header data={data.header} />

  <section class="py-16 px-5 max-w-5xl mx-auto">
    <div class="mx-auto flex flex-col justify-center items-center">
      <MdOutlineQuiz className="size-14 text-mustard-yellow mb-5" />
      <p class="uppercase text-primary font-bold tracking-widest">
        Fill out the quiz to find out if you're ready to become a pilot
      </p>
    </div>

    <form
      id="quiz-form"
      method="POST"
      action=""
      class="max-w-3xl mx-auto flex flex-col justify-center align-middle items-center space-y-8"
    >
      <p class="text-primary text-lg w-full font-light mt-2">
        <b>Purpose:</b> To help prospective students evaluate their preparedness
        for flight training and allow NextGen Flight Academy to tailor a personalized
        training plan.
        <br /><br />

        <b>Instructions:</b> Please answer the following questions honestly. Your
        responses will remain confidential and will be used solely to assist in your
        flight training journey.
      </p>

      <!-- Render quiz questions from the array -->
      {
        quizQuestions.map((question, index) => {
          // Render section header if this question has a section
          const shouldRenderSection =
            question.section &&
            (!quizQuestions[index - 1] ||
              quizQuestions[index - 1].section !== question.section);

          return (
            <>
              {shouldRenderSection && (
                <h3 class="text-primary text-2xl font-extrabold w-full mt-10">
                  {question.section}
                </h3>
              )}

              {question.note && !question.type && (
                <p class="text-primary text-lg w-full font-light mt-2">
                  <b>Note:</b> {question.note}
                </p>
              )}

              {/* Render input fields for Personal Information section */}
              {question.fields && question.fields.length > 0 && (
                <div class="w-full mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                  {question.fields.map((field) => (
                    <div class={field.colSpan || "sm:col-span-3"}>
                      <label
                        for={field.id}
                        class="block font-medium leading-6 text-primary-dark"
                      >
                        {field.label}
                      </label>
                      <div class="mt-2">
                        <input
                          type={field.type}
                          name={field.name}
                          id={field.id}
                          autocomplete={field.autocomplete}
                          class="block w-full p-2 border-0 py-1.5 text-primary-dark shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:leading-6"
                          required={field.required}
                        />
                      </div>
                    </div>
                  ))}
                  {/* Honeypot field */}
                  <p class="hidden">
                    <label>
                      Don't fill this out if you're human:{" "}
                      <input name="confirm-email" />
                    </label>
                  </p>
                </div>
              )}

              {/* Render radio button groups */}
              {question.type === "radio" && (
                <fieldset class="w-full">
                  <legend class="font-medium leading-6 text-primary-dark">
                    {question.legend}
                  </legend>
                  {question.note && (
                    <p class="text-gray-500 text-sm">{question.note}</p>
                  )}
                  <div class="mt-2 space-y-1">
                    {question.options.map((option) => (
                      <div class="flex items-center gap-x-3">
                        <input
                          id={option.id}
                          name={question.name}
                          type="radio"
                          class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                          value={option.value}
                          required={option.required || question.required}
                        />
                        <label
                          for={option.id}
                          class="block leading-6 text-gray-600"
                        >
                          {option.label}
                        </label>
                      </div>
                    ))}
                  </div>
                </fieldset>
              )}

              {/* Render checkbox groups */}
              {question.type === "checkbox" && (
                <fieldset class="w-full">
                  <legend class="font-medium leading-6 text-primary-dark">
                    {question.legend}
                  </legend>
                  {question.note && (
                    <p class="text-gray-500 text-sm">{question.note}</p>
                  )}
                  <div class="mt-2 space-y-1">
                    {question.options.map((option) => (
                      <div class="relative flex gap-x-3">
                        <div class="flex h-6 items-center">
                          <input
                            id={option.id}
                            name={question.name}
                            type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                            value={option.value}
                          />
                        </div>
                        <div class="leading-6">
                          <label for={option.id} class="text-gray-600">
                            {option.label}
                          </label>
                        </div>
                      </div>
                    ))}

                    {/* Render other text input if this question has other option */}
                    {question.hasOther && (
                      <>
                        <input
                          class="block w-full p-2 border-0 py-1.5 text-primary-dark shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:leading-6"
                          type="text"
                          name={question.name}
                          id={question.otherTextId}
                        />
                        <div
                          id={question.otherErrorId}
                          class="hidden border-l-4 border-yellow-400 bg-yellow-50 p-4"
                        >
                          <div class="flex">
                            <div class="shrink-0">
                              <svg
                                viewBox="0 0 20 20"
                                fill="currentColor"
                                data-slot="icon"
                                aria-hidden="true"
                                class="size-5 text-yellow-400"
                              >
                                <path
                                  d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
                                  clip-rule="evenodd"
                                  fill-rule="evenodd"
                                />
                              </svg>
                            </div>
                            <div class="ml-3">
                              <p class="text-sm text-yellow-700">
                                Please fill out the text field above.
                              </p>
                            </div>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </fieldset>
              )}

              {/* Render note after fieldset if it exists */}
              {question.note && question.type && (
                <p class="text-primary text-lg w-full font-light mt-2">
                  <b>Note:</b> {question.note}
                </p>
              )}
            </>
          );
        })
      }

      <!-- Additional Information (textarea) -->
      <h3 class="text-primary text-2xl font-extrabold w-full mt-10">
        Additional Information
      </h3>

      <div class="col-span-full w-full">
        <label
          for="expectations"
          class="block font-medium leading-6 text-primary-dark"
        >
          Is there anything else you'd like us to know about your interests or
          expectations regarding flight training?
        </label>
        <div class="mt-2">
          <textarea
            id="expectations"
            name="anything-else-youd-like-us-to-know-about-your-interests-or-expectations-regarding-flight-training"
            rows="3"
            class="block w-full p-2 border-0 py-1.5 text-primary-dark shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:leading-6"
          ></textarea>
        </div>
      </div>

      <!-- Visit scheduling section -->
      <fieldset class="flex flex-col mt-4 w-full">
        <legend class="mb-2 text-gray-800 w-full">
          Would you like to schedule a visit to NextGen Flight Academy?
        </legend>
        <div>
          <div>
            <input
              type="radio"
              class="mx-2"
              id="yes-visit"
              name="visit-nextgen"
              value="Yes"
              required
            />
            <label for="yes-visit">Yes</label>
          </div>
          <div>
            <input
              type="radio"
              class="mx-2"
              id="no-visit"
              name="visit-nextgen"
              value="No"
              required
            />
            <label for="no-visit">No</label>
          </div>
        </div>
      </fieldset>

      <div id="location-container" class="hidden flex-col gap-2 w-full">
        <label for="visit-location">Choose a location:</label>
        <select
          name="visit-location"
          id="visit-location"
          class="w-36 px-3 py-2 border border-gray-400"
        >
          <option value="riverside">Riverside</option>
          <option value="redlands">Redlands</option>
        </select>
        <label for="visit-date">Preferred Date:</label>
        <input
          type="date"
          name="visit-date"
          id="visit-date"
          class="w-40 px-3 py-2 border border-gray-400"
          required
        />
        <label for="visit-time">Preferred Time:</label>
        <select
          name="visit-time"
          id="visit-time"
          class="w-40 px-3 py-2 border border-gray-400"
          required
        >
          <option value="">Select a time</option>
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
        </select>
      </div>

      <p class="text-primary text-lg w-full font-light mt-2">
        <b>Final Note</b><br />
        Once submitted, your answers will be reviewed by our team, and we'll reach
        out to discuss your personalized training path. This assessment can be exported
        into your student profile and used to tailor recommendations for scheduling,
        instruction format, and financial planning.
      </p>

      <div class="flex gap-3 my-5 items-center">
        <input
          type="checkbox"
          name="agree-data-collection"
          id="agree-data-collection"
          class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
        />
        <label for="agree-data-collection" class="text-gray-500 text-sm">
          {data.checkboxText}
        </label>
      </div>

      <button
        type="submit"
        id="submit-button"
        class="btn-primary cursor-not-allowed bg-gray-400 hover:bg-gray-400 hover:text-white"
        disabled
      >
        Submit
      </button>
    </form>
  </section>
</BaseLayout>

<script define:vars={{ QUIZ_FORM_WEBHOOK_URL, PORTAL_API_KEY, otherFields }}>
  const checkbox = document.getElementById("agree-data-collection");
  const submitButton = document.getElementById("submit-button");
  const yesVisit = document.getElementById("yes-visit");
  const noVisit = document.getElementById("no-visit");
  let isSubmitting = false;

  function updateSubmitButtonState(enabled, text) {
    submitButton.disabled = !enabled;
    if (text) {
      submitButton.textContent = text;
    }

    if (enabled) {
      submitButton.classList.remove(
        "cursor-not-allowed",
        "bg-gray-400",
        "hover:bg-gray-400",
        "hover:text-white",
      );
    } else {
      submitButton.classList.add(
        "cursor-not-allowed",
        "bg-gray-400",
        "hover:bg-gray-400",
        "hover:text-white",
      );
    }
  }

  function checkOtherFilled(idOther, idOtherText, idErrorMsg) {
    const other = document.getElementById(idOther);
    const otherText = document.getElementById(idOtherText);
    const otherErrorMsg = document.getElementById(idErrorMsg);

    if (other && other.checked && otherText.value.trim() === "") {
      otherErrorMsg.classList.remove("hidden");
      otherText.focus();
      return false;
    }

    if (otherErrorMsg) {
      otherErrorMsg.classList.add("hidden");
    }
    return true;
  }

  yesVisit.addEventListener("change", function () {
    if (yesVisit.checked) {
      document.getElementById("location-container").classList.remove("hidden");
      document.getElementById("location-container").classList.add("flex");
    } else {
      document.getElementById("location-container").classList.add("hidden");
    }
  });

  noVisit.addEventListener("change", function () {
    if (noVisit.checked) {
      document.getElementById("location-container").classList.add("hidden");
    }
  });

  const dateInput = document.getElementById("visit-date");
  const today = new Date().toISOString().split("T")[0];
  dateInput.setAttribute("min", today);

  checkbox.addEventListener("change", function () {
    updateSubmitButtonState(checkbox.checked);
  });

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("quiz-form");
    if (!form) {
      console.error("Form element not found.");
      return;
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (isSubmitting) return;

      const formData = new FormData(form);
      const confirmEmail = formData.get("confirm-email")?.trim();
      if (confirmEmail) return;

      // Check other fields using the otherFields array from front matter
      for (const item of otherFields) {
        if (!checkOtherFilled(item.id, item.idText, item.idErrorMsg)) {
          return;
        }
      }

      const inspirations = [];
      formData.getAll("inspirations").forEach((inspiration) => {
        inspirations.push(inspiration);
      });

      formData.delete("inspirations");
      formData.append("what-inspires-you", inspirations.join(","));

      const kindOfGuidance = [];
      formData.getAll("kind-of-guidance").forEach((guidance) => {
        kindOfGuidance.push(guidance);
      });

      formData.delete("kind-of-guidance");
      formData.append(
        "what-kind-of-guidance-and-support-you-prefer",
        kindOfGuidance.join(","),
      );

      const webhookURL = QUIZ_FORM_WEBHOOK_URL;
      const apiKey = PORTAL_API_KEY;

      const urlEncodedBody = new URLSearchParams(formData).toString();

      const jsonBody = {
        first_name: formData.get("first-name")?.trim() || "",
        last_name: formData.get("last-name")?.trim() || "",
        email: formData.get("email")?.trim() || "",
        phone: formData.get("phone")?.trim() || "",
        "visit-location": formData.get("visit-location")?.trim() || "",
        "visit-date": formData.get("visit-date")?.trim() || "",
        "visit-time": formData.get("visit-time")?.trim() || "",
        campaign: "quiz",
        account_random_id: "ac_vwzfezsv",
        metadata: {
          "preferred-method-of-contact":
            formData.get("method-contact")?.trim() || "",
          "level-of-experience":
            formData.get("level-of-experience")?.trim() || "",
          "aspirations-and-mindset": {
            "what-inspires-you": inspirations.join(","),
            "preferred-learning-style":
              formData.get("preferred-learning-style")?.trim() || "",
            "pilot-certainty": formData.get("pilot-certainty")?.trim() || "",
            "preferred-approach":
              formData.get("preferred-approach")?.trim() || "",
            "what-kind-of-guidance-and-support-you-prefer":
              kindOfGuidance.join(","),
          },
          medical: {
            "medical-age-range":
              formData.get("medical-age-range")?.trim() || "",
            "medical-weight-range":
              formData.get("medical-weight-range")?.trim() || "",
            "medical-conditions":
              formData.get("medical-conditions")?.trim() || "",
            "medical-medication":
              formData.get("medical-medication")?.trim() || "",
          },
          "time-commitment": {
            "time-commitment-weekly":
              formData.get("time-commitment-weekly")?.trim() || "",
            "time-commitment-flexibility":
              formData.get("time-commitment-flexibility")?.trim() || "",
          },
          financial: formData.get("financial")?.trim() || "",
          "anything-else-youd-like-us-to-know-about-your-interests-or-expectations-regarding-flight-training":
            formData
              .get(
                "anything-else-youd-like-us-to-know-about-your-interests-or-expectations-regarding-flight-training",
              )
              ?.trim() || "",
          "visit-nextgen": formData.get("visit-nextgen")?.trim() || "",
          "visit-location": formData.get("visit-location")?.trim() || "",
        },
      };

      try {
        isSubmitting = true;
        updateSubmitButtonState(false, "Submitting...");

        const [crmResponse, portalResponse] = await Promise.all([
          fetch(webhookURL, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: urlEncodedBody,
          }),
          fetch("https://portal.rightruddermarketing.com/api/leads", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              "x-api-key": apiKey,
            },
            body: JSON.stringify(jsonBody),
          }),
        ]);

        if (crmResponse.ok && portalResponse.ok) {
          window.location.href = "/quiz-confirmation";
        } else {
          console.error("Submission failed", {
            crm: {
              status: crmResponse.status,
              body: await crmResponse.json(),
            },
            portal: {
              status: portalResponse.status,
              body: await portalResponse.json(),
            },
          });
          alert(
            "There was an error submitting your form. Please try again or contact us directly.",
          );
        }
      } catch (err) {
        console.error("Submission error:", err);
        alert(
          "There was an error submitting your form. Please try again or contact us directly.",
        );
      } finally {
        isSubmitting = false;
        updateSubmitButtonState(false, "Submit");
      }
    });
  });
</script>
